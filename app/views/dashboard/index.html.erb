<div class="container mt-4">
  <div class="row">
    <!-- Sidebar: User Profile Summary -->
    <div class="col-md-4 col-lg-3 mb-4">
      <div class="card shadow-sm">
        <div class="card-body text-center">
          <div class="bg-secondary text-white rounded-circle d-flex align-items-center justify-content-center mx-auto mb-3" style="width: 80px; height: 80px; font-size: 2rem;">
            <%= @profile.first_name.first %><%= @profile.last_name.first %>
          </div>
          
          <h5 class="card-title mb-1"><%= @profile.first_name %> <%= @profile.last_name %></h5>
          <p class="text-muted small mb-3"><%= @profile.city %>, <%= @profile.state %></p>
          
          <hr>
          
          <div class="d-grid gap-2">
            <button class="btn btn-outline-primary btn-sm">Edit Profile</button>
            <%= button_to "Log Out", logout_path, method: :delete, class: "btn btn-outline-danger btn-sm w-100" %>
          </div>
        </div>
      </div>
    </div>

    <!-- Main Content -->
    <div class="col-md-8 col-lg-9">
      <h2 class="mb-4">My Dashboard</h2>

      <!-- Stats Row -->
      <div class="row g-3 mb-4">
        <div class="col-sm-4">
          <div class="card bg-primary text-white h-100">
            <div class="card-body">
              <h6 class="card-title opacity-75">Active Licenses</h6>
              <h2 class="display-6 fw-bold mb-0"><%= @licenses.count %></h2>
            </div>
          </div>
        </div>
        <div class="col-sm-4">
          <div class="card bg-success text-white h-100">
            <div class="card-body">
              <h6 class="card-title opacity-75">Total CEUs</h6>
              <!-- Updated to sum the duration -->
              <h2 class="display-6 fw-bold mb-0"><%= @ceus.sum(:duration) %></h2>
            </div>
          </div>
        </div>
        <div class="col-sm-4">
          <div class="card bg-warning text-dark h-100">
            <div class="card-body">
              <h6 class="card-title opacity-75">Expiring Soon</h6>
              <h2 class="display-6 fw-bold mb-0">0</h2>
            </div>
          </div>
        </div>
      </div>

      <!-- Section 1: Licenses -->
      <div class="card shadow-sm mb-4">
        <div class="card-header bg-white d-flex justify-content-between align-items-center py-3">
          <h5 class="mb-0">Professional Licenses</h5>
          <%= link_to "+ Add License", new_professional_license_path, class: "btn btn-primary btn-sm" %>
        </div>
        <div class="card-body">
          <% if @licenses.empty? %>
            <div class="text-center py-4 text-muted">
              <p>You haven't added any professional licenses yet.</p>
              <%= link_to "Add Your First License", new_professional_license_path, class: "btn btn-outline-primary btn-sm" %>
            </div>
          <% else %>
            <div class="table-responsive">
              <table class="table table-hover text-start align-middle mb-0">
                <thead>
                  <tr>
                    <th>Authority</th>
                    <th>Number</th>
                    <th>Expires</th>
                    <th>Status</th>
                    <th></th>
                  </tr>
                </thead>
                <tbody>
                  <% @licenses.each do |license| %>
                    <tr>
                      <td><%= license.issuing_authority.name %></td>
                      <td><%= license.license_number %></td>
                      <td><%= license.expiration_date.strftime("%b %d, %Y") %></td>
                      <td>
                        <span class="badge bg-<%= license.status_label == 'Active' ? 'success' : 'warning' %>">
                          <%= license.status_label %>
                        </span>
                      </td>
                      <td class="text-end">
                        <%= button_to "Remove", professional_license_path(license), method: :delete, class: "btn btn-sm btn-outline-danger", data: { turbo_confirm: "Are you sure?" } %>
                      </td>
                    </tr>
                  <% end %>
                </tbody>
              </table>
            </div>
          <% end %>
        </div>
      </div>

      <!-- Section 2: CEU History -->
      <div class="card shadow-sm">
        <div class="card-header bg-white d-flex justify-content-between align-items-center py-3">
          <h5 class="mb-0">CEU History</h5>
          <%= link_to "+ Log CEU", new_ceu_path, class: "btn btn-success btn-sm text-white" %>
        </div>
        <div class="card-body">
          <% if @ceus.empty? %>
            <div class="text-center py-4 text-muted">
              <p>No continuing education recorded yet.</p>
              <%= link_to "Log Your First Class", new_ceu_path, class: "btn btn-outline-success btn-sm" %>
            </div>
          <% else %>
            <div class="table-responsive">
              <table class="table table-hover text-start align-middle mb-0">
                <thead>
                  <tr>
                    <th>Date</th>
                    <th>Activity / Course</th>
                    <th>Credits</th>
                    <th>Proof</th>
                    <th></th>
                  </tr>
                </thead>
                <tbody>
                  <% @ceus.order(date: :desc).each do |ceu| %>
                    <tr>
                      <td><%= ceu.date.strftime("%b %d, %Y") %></td>
                      <td><%= ceu.title %></td>
                      <td><span class="badge bg-light text-dark border"><%= ceu.duration %></span></td>
                      
                      <!-- Certificate Column -->
                      <td>
                        <% if ceu.certificate.attached? %>
                          <%= link_to "View", rails_blob_path(ceu.certificate, disposition: "preview"), target: "_blank", class: "btn btn-sm btn-outline-secondary" %>
                        <% else %>
                          <span class="text-muted small">None</span>
                        <% end %>
                      </td>

                      <td class="text-end">
                        <%= button_to "Remove", ceu_path(ceu), method: :delete, class: "btn btn-sm btn-outline-danger", data: { turbo_confirm: "Delete this record?" } %>
                      </td>
                    </tr>
                  <% end %>
                </tbody>
              </table>
            </div>
          <% end %>
        </div>
      </div>

    </div>
  </div>
</div>